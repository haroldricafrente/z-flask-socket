{% extends "base.html" %}

{% block title %}Mushkin - Live Feed{% endblock %}

{% block content %}
<h1>Live Feed</h1>

<ul class="breadcrumbs">
    <li><a href="{{ url_for('index') }}">Home</a></li>
    <li class="divider">/</li>
    <li><a href="{{ url_for('live') }}" class="active">Live</a></li>
</ul>

<!-- Dropdown for selecting size -->
<br>
<label for="sizeSelector">Select Camera Size:</label>
<select id="sizeSelector">
    <option value="small">Small</option>
    <option value="medium" selected>Medium</option>
    <option value="large">Large</option>
</select>

<div class="live-page">
    <div class="live-container">
        <div class="live-grid">
            {% for mushroom, ip in {"Chestnut": "192.168.100.189", "Milky": "192.168.100.190", "Reishi": "192.168.100.191", "Shiitake": "192.168.100.192", "White Oyster": "192.168.100.193"}.items() %}
            <div class="camera-card">
                <div class="camera-header">
                    <h2>{{ mushroom }} Camera</h2>
                    <button class="capture-btn" onclick="captureImage('{{ ip }}', '{{ mushroom.lower() }}')">Capture</button>
                </div>
                <img id="{{ mushroom.lower().replace(' ', '_') }}-stream" src="http://{{ ip }}/stream_{{ mushroom.lower().replace(' ', '_') }}" alt="{{ mushroom }} Camera Stream" class="camera-stream">

            </div>
            {% endfor %}
        </div>
    </div>
</div>


<!-- Upload Status Modal -->
<div id="uploadStatusModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <p id="uploadMessage"></p>
    </div>
</div>

<!-- JavaScript to handle image capture, auto-refresh, and size selection -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // List of camera IDs that match the Flask server's routing
        const cameraIds = ["chestnut", "milky", "reishi", "shiitake", "white_oyster"];

        // Refresh the camera streams every 5 seconds
        function refreshStreams() {
            cameraIds.forEach(id => {
                let streamImg = document.getElementById(`${id}-stream`);
                let timestamp = new Date().getTime();
                // Use EC2 instance for streaming
                streamImg.src = `http://52.64.254.252:5000/stream?camera_id=${id}&t=${timestamp}`;
            });
        }
        setInterval(refreshStreams, 5000);

        // Show upload status in a modal
        function showUploadStatus(message, isSuccess) {
            const modal = document.getElementById("uploadStatusModal");
            const messageElement = document.getElementById("uploadMessage");
            messageElement.innerHTML = message;
            messageElement.style.color = isSuccess ? "green" : "red";
            modal.style.display = "block";
            document.querySelector(".close").onclick = function () {
                modal.style.display = "none";
            };
        }

        // Capture image through the EC2 server
        function captureImage(mushroom) {
            const flaskServer = "{{ url_for('upload_image', _external=True) }}";
            fetch(`http://52.64.254.252:5000/capture?camera_id=${mushroom}`)
                .then(response => {
                    if (!response.ok) throw new Error(`ESP32 Error: ${response.statusText}`);
                    return response.blob();
                })
                .then(blob => {
                    let formData = new FormData();
                    formData.append("file", blob, `capture_${mushroom}_${new Date().toISOString()}.jpg`);
                    formData.append("mushroom", mushroom);
                    return fetch(flaskServer, { method: "POST", body: formData });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes("✅ Uploaded Successfully")) {
                        showUploadStatus(`✅ ${mushroom} image uploaded successfully to Google Drive!`, true);
                    } else {
                        showUploadStatus(`❌ Upload failed for ${mushroom}: ` + (data.error || "Unknown error"), false);
                    }
                })
                .catch(error => {
                    showUploadStatus(`❌ Upload error for ${mushroom}: ` + error.message, false);
                });
        }

        // Size Selector for resizing camera streams
        document.getElementById("sizeSelector").addEventListener("change", function () {
            let size = this.value;
            document.querySelectorAll(".camera-stream").forEach(img => {
                img.style.width = size === "small" ? "200px" : size === "medium" ? "400px" : "600px";
                img.style.height = "auto";
            });
        });

        // Expose the capture function to the global scope
        window.captureImage = captureImage;
    });
</script>


<!-- CSS Styling -->
<style>
    .camera-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
    }
    .capture-btn {
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }
    .capture-btn:hover {
        background-color: #0056b3;
    }
    @media (max-width: 600px) {
        .camera-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .capture-btn {
            width: 100%;
        }
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        box-shadow: 0px 0px 10px gray;
        border-radius: 8px;
    }
    .modal-content {
        text-align: center;
    }
    .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
    }
</style>

{% endblock %}
